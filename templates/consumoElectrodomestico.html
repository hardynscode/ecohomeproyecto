{% extends "layout.html" %}

{% block content %}
<div class="service-item position-relative">
	<nav aria-label="breadcrumb px-5">
		<ol class="breadcrumb px-3">
			<li class="breadcrumb-item btn-ir-home"><a href="/home">Home</a></li>
			<li class="breadcrumb-item"><a href="/detailshome?idCasa={{idCasa}}">{{idCasa}}</a></li>
			<li class="breadcrumb-item"><a href="/detailshome/{{idCasa}}/electrodomesticos">Electrodomesticos</a></li>
			<li class="breadcrumb-item active" aria-current="page">Datos de Consumo</li>
		</ol>
	</nav>

	<div class="service py-4 px-2">
		<h6 class="text-dark e font-weight-medium px-3">Datos de Consumo del Electrodomestico:</h6>
	</div>
</div>

<section class="vh-50 ">
	<div class="container">
		<div class="row">
			<div class="col-lg-12">
				<div class="bg-white shadow rounded">
					<div class="row">
						<div class="col-md-4">
							<div class="form-left h-100 py-5 px-2">
								<form class="row g-4" id="form-edicion-electrodomestico">
									<div class="col-12">
										<label>Tipo de Electrodomestico</label>
										<select class="form-control text-small" id="tipoElectrodomestico"
											name="tipoElectrodomestico" disabled>
										</select>
									</div>

									<div class="col-12">
										<label>Tipo de Eficiencia</label>
										<select class="form-control text-small" id="tipoEficiencia"
											name="tipoEficiencia" disabled>
										</select>
									</div>

									<div class="col-12">
										<label>Consumo por mes (kWh / mes)</label>
										<input type="number" class="form-control text-small" id="kwhMes" disabled>
									</div>

									<div class="col-12">
										<label>Tomacorriente Actual</label>
										<select class="form-control text-small" id="tomacorrienteActual"
											name="tomacorrienteActual" disabled>
										</select>
									</div>

									<div class="col-12">
										<label>Estado de Conexion</label>
										<select class="form-control text-small" id="estadoConexion"
											name="estadoConexion" disabled>
											<option value="conectado">Conectado</option>
											<option value="desconectado">Desconectado</option>
										</select>
									</div>

								</form>
							</div>
						</div>
						<div class="col-md-8">
							<div class="py-5 px-1">
								<canvas id="grafica"></canvas>
							</div>
							<div class="form-rigth center h-100 pb-5 px-5 col-md-12">
								<h3>Calculos</h3>
								<div class="col-lg-7 pb-2">
									<label>Consumo por hora (Wh)</label>
									<input type="number" class="form-control text-small" id="watsHora" disabled>
								</div>
								<div class="col-lg-7 pb-2">
									<label>Tiempo Transcurrido (Horas)</label>
									<input type="number" class="form-control text-small" id="tiempoTranscurrido" disabled>
								</div>
								<div class="col-lg-7 pb-2">
									<label>Consumo Total (Wh)</label>
									<input type="number" class="form-control text-small" id="consumoTotal" disabled>
								</div>
								<div class="col-lg-7 pb-2">
									<label>Potencia Promedio (vatios)</label>
									<input type="number" class="form-control text-small" id="promedioPotencia" disabled>
								</div>
								<div class="col-lg-7 pb-2">
									<label>Consumo x Potencia Promedio = Consumo Real</label>
									<input type="number" class="form-control text-small" id="consumoPorPotencia" disabled>
								</div>
							</div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>
</section>
{% endblock %}

{% block scripts %}

<script src="https://cdn.jsdelivr.net/npm/chart.js@latest/dist/Chart.min.js"></script>
<script type="text/javascript" src="/static/js/moment.min.js"></script>

<script type="text/javascript">

	// Validacion de seguridad
	const loggedUser = JSON.parse(localStorage.getItem('user-ecohome'));
	if (loggedUser.rol != "cliente") {
		localStorage.setItem('user-ecohome', null);
		window.location.href = "/";
	}

	let dataElectrodomestico = null;
	let dataConsumo = null;

	// obtenemos la informacion del usuario del local storage
	const usuarioLogueado = JSON.parse(localStorage.getItem('user-ecohome'));
	const identificacion = usuarioLogueado.identificacion;

	$(document).ready(function () {

		//Cargar los tipos de electrodomesticos
		$.ajax({
			type: "GET",
			url: "http://127.0.0.1:5000/api/settings?tipo=tiposElectrodomesticos",
			dataType: "json",
			contentType: "application/json; charset=utf-8",
			async: true,
			success: function (response) {

				const registros = response;
				let content = "<option value=''>Seleccione..</option>";

				for (const key in registros) {
					if (Object.hasOwnProperty.call(registros, key)) {
						const elemento = registros[key];
						content += "<option value='" + key + "'>" + elemento + "</option>";
					}
				}
				$("#tipoElectrodomestico").html(content);
				cargarTiposEficiencia();
			},
			error: function (response) {
				console.log(response.responseJSON.message);
			}
		});

		// Cargar los tipos de eficiencia en el selector
		function cargarTiposEficiencia() {
			$.ajax({
				type: "GET",
				url: "http://127.0.0.1:5000/api/settings?tipo=tiposEficiencia",
				dataType: "json",
				contentType: "application/json; charset=utf-8",
				async: true,
				success: function (response) {

					const registros = response;
					let content = "<option value=''>Seleccione..</option>";

					for (const key in registros) {
						if (Object.hasOwnProperty.call(registros, key)) {
							const elemento = registros[key];
							content += "<option value='" + key + "'>Tipo: " + elemento.nombre + " (Desde " + elemento.limiteInferior + "% hasta " + elemento.limiteSuperior + " %)</option>";
						}
					}
					$("#tipoEficiencia").html(content);
					cargarTomacorrientes();
				},
				error: function (response) {
					console.log(response.responseJSON.message);
				}
			});
		}

		// cargamos los tomacorrientes 
		function cargarTomacorrientes() {
			$.ajax({
				type: "GET",
				url: "http://127.0.0.1:5000/api/users/" + identificacion + "/houses/{{idCasa}}/tomacorrientes",
				dataType: "json",
				contentType: "application/json; charset=utf-8",
				async: true,
				success: function (response) {
					const tomacorrientes = response;

					let content = "<option value=''>Seleccione..</option>";
					let cantidadTomacorrientes = 0;
					for (const key in tomacorrientes) {
						if (Object.hasOwnProperty.call(tomacorrientes, key)) {
							const tomaActual = tomacorrientes[key];
							cantidadTomacorrientes += 1;
							const descripcionTomaActual = "<b>Zona:</b> " + tomaActual.zona + " - <b>Tipo:</b> " + tomaActual.tipo + " <b>Descripcion: </b>" + tomaActual.descripcion;
							content += "<option value='" + key + "'>" + descripcionTomaActual + "</option>";
						}
					}
					$("#tomacorrienteActual").html(content);

					if (cantidadTomacorrientes == 0) {
						$("#sin-tomas").removeClass("d-none");
					}
					cargarTiposElectrodomesticos();
				},
				error: function (response) {
					console.log(response.responseJSON.message);
				}
			});
		}

		// Cargar los tipos de electrodomesticos y despegarlos en el selector
		function cargarTiposElectrodomesticos() {
			$.ajax({
				type: "GET",
				url: "http://127.0.0.1:5000/api/settings?tipo=tiposElectrodomesticos",
				dataType: "json",
				contentType: "application/json; charset=utf-8",
				async: true,
				success: function (response) {

					const registros = response;
					console.log("tipos e", registros);
					let content = "<option value=''>Seleccione..</option>";

					for (const key in registros) {
						if (Object.hasOwnProperty.call(registros, key)) {
							const elemento = registros[key];
							content += "<option value='" + key + "'>" + elemento + "</option>";
						}
					}

					$("#tipoElectrodomestico").html(content);

					cargarElectrodomestico();
				},
				error: function (response) {
					console.log(response.responseJSON.message);
				}
			});
		}

		function cargarElectrodomestico() {
			$.ajax({
				type: "GET",
				url: "http://127.0.0.1:5000/api/users/" + identificacion + "/houses/{{idCasa}}/electrodomesticos/{{idElectrodomestico}}",
				dataType: "json",
				contentType: "application/json; charset=utf-8",
				async: true,
				success: function (response) {

					dataElectrodomestico = response;

					$("#estadoConexion").val(dataElectrodomestico.estadoConexion);
					$('#kwhMes').val(dataElectrodomestico.kwhMes);

					const horasMes = 730;
					const watsMes = dataElectrodomestico.kwhMes * 1000;
					const watsHora = watsMes / horasMes;
					$("#watsHora").val(watsHora);

					$("#tipoEficiencia").val(dataElectrodomestico.tipoEficiencia);
					$("#tipoElectrodomestico").val(dataElectrodomestico.tipoElectrodomestico);
					$("#tomacorrienteActual").val(dataElectrodomestico.tomacorrienteActual);

					cargarDataConsumo();
				},
				error: function (response) {
					console.log(response.responseJSON.message);
				}
			});
		}

		function cargarDataConsumo() {

			$.ajax({
				type: "GET",
				url: "http://127.0.0.1:5000/api/users/" + identificacion + "/houses/{{idCasa}}/electrodomesticos/{{idElectrodomestico}}/consumo",
				dataType: "json",
				contentType: "application/json; charset=utf-8",
				async: true,
				success: function (response) {
					dataConsumo = response;
					pintarGrafica(dataConsumo);
				},
				error: function (response) {
					console.log(response.responseJSON.message);
				}
			});
		}

		function pintarGrafica(dataConsumo) {

			const etiquetas = [];
			const potencia = [];
			dataConsumo.forEach(element => {
				etiquetas.push(element.fecha);
				potencia.push(element.potencia);
			});

			const sumatoria = potencia.reduce(function (a, b) {
				return a + b;
			}, 0);
			const promedioPotencia = sumatoria / potencia.length;
			$("#promedioPotencia").val(promedioPotencia);


			const fecha1 = moment(etiquetas[0], "YYYY-MM-DD HH:mm:ss");
			const fecha2 = moment(etiquetas[etiquetas.length - 1], "YYYY-MM-DD HH:mm:ss");

			const horasTranscurridas = fecha2.diff(fecha1, 'h'); // Diff in hours
			$("#tiempoTranscurrido").val(horasTranscurridas);

			const consumoTotal = horasTranscurridas * $("#watsHora").val();
			$("#consumoTotal").val(consumoTotal);

			const consumoPorPotencia = consumoTotal * promedioPotencia;
			$("#consumoPorPotencia").val(consumoPorPotencia);

			const datosVentas2020 = {
				label: "Potencia",
				data: potencia,
				backgroundColor: 'rgba(54, 162, 235, 0.2)', // Color de fondo
				borderColor: 'rgba(54, 162, 235, 1)', // Color del borde
				borderWidth: 1,// Ancho del borde
			};

			// Obtener una referencia al elemento canvas del DOM
			const $grafica = $("#grafica");

			new Chart($grafica, {
				type: 'line',// Tipo de gráfica
				data: {
					labels: etiquetas,
					datasets: [
						datosVentas2020,
						// Aquí más datos...
					]
				},
				options: {
					scales: {
						yAxes: [{
							ticks: {
								beginAtZero: true
							}
						}],
					},
				}
			});
		}
	});

</script>
{% endblock %}








</body>

</html>